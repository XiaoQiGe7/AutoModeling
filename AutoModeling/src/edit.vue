<template>
<div>
  <div class="layer">
    <div @click="transform3D()">
      <!-- 2D 3D -->
      <svg v-show="edit.is3D" t="1635142241861" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5764" width="100%" height="100%"><path d="M343.5 863.4c-121.6-57.7-208.9-176-222.1-316H65.5c19 229.4 210.8 409.6 445 409.6 8.4 0 16.4-0.7 24.6-1.3l-141.9-142-49.7 49.7z m33.1-243c-7.1 0-13.6-0.9-19.6-3.2-5.8-2-10.8-5-14.9-8.8-4.1-3.7-7.3-8.4-9.5-13.6-2.2-5.4-3.4-11.2-3.4-17.5h-48.4c0 13.4 2.6 25.1 7.8 35.4 5.2 10.2 12.1 18.8 20.9 25.5 8.8 6.9 18.8 11.9 30.3 15.5 11.5 3.7 23.5 5.4 36.1 5.4 13.8 0 26.6-1.9 38.5-5.6 11.9-3.7 22.2-9.3 30.9-16.6 8.8-7.3 15.5-16.2 20.5-26.8 4.8-10.6 7.4-22.7 7.4-36.3 0-7.3-0.9-14.2-2.6-20.9-1.9-6.7-4.7-13-8.4-19-3.9-6-8.9-11.2-15.1-16-6.9-5-14.5-9-22.5-11.7 7.4-3.4 14-7.4 19.6-12.3 5.6-4.8 10.2-10.1 14-15.5 3.7-5.6 6.5-11.2 8.4-17.1 1.9-6 2.8-11.9 2.8-17.7 0-13.6-2.2-25.5-6.7-35.7-4.5-10.2-10.8-18.8-19-25.7-8.2-6.9-17.9-12.1-29.4-15.6-12.4-3.7-25.4-5.6-38.4-5.4-13.4 0-25.9 2-37.2 6-11.4 3.9-21 9.5-29.2 16.6-8.2 7.1-14.5 15.5-19.2 25.1-4.7 9.7-6.9 20.3-6.9 31.7h48.4c0-6.3 1.1-11.9 3.4-16.8 2.2-5 5.4-9.3 9.3-12.7 3.9-3.5 8.8-6.3 14.2-8.2 5.4-1.9 11.4-3 17.7-3 14.9 0 25.9 3.9 33.1 11.5 7.3 7.6 10.8 18.4 10.8 32.2 0 6.7-0.9 12.7-3 18.1-2 5.4-5 10.1-9.1 14-4.1 3.9-9.3 6.9-15.3 9.1-6.1 2.2-13.4 3.4-21.6 3.4h-28.7v38.2h28.7c8.2 0 15.6 0.9 22.2 2.8s12.1 4.7 16.8 8.8c4.7 3.9 8.2 8.9 10.8 14.9 2.4 6 3.7 13 3.7 21.2 0 15.1-4.3 26.6-13 34.6-8.4 7.8-20.1 11.7-35.2 11.7z m318.8-220.6c-11.9-12.4-26.3-22.1-42.3-28.5-16.6-6.7-34.6-10.1-54.6-10.1h-88.1v297.9H596c20.7 0 39.3-3.4 56.2-10.1 16.9-6.7 31.3-16.2 43.2-28.5 11.9-12.3 21.2-27.2 27.6-44.5 6.5-17.3 9.7-36.9 9.7-58.5v-14.7c0-21.6-3.4-41-9.9-58.5-6.6-17.4-15.7-32.3-27.4-44.5z m-14.7 118c0 15.5-1.7 29.6-5.4 41.9-3.5 12.5-8.8 22.9-15.8 31.5-7.1 8.6-15.8 15.1-26.4 19.7-10.6 4.5-22.9 6.9-37.1 6.9h-33.7V402.9h36.3c26.8 0 47.1 8.6 61.3 25.5 14 17.1 21 41.7 21 74.1v15.3h-0.2zM510.5 63.3c-8.4 0-16.4 0.7-24.6 1.3l141.9 142.1 49.5-49.5C799.1 214.7 886.4 333 899.6 473h55.9c-19-229.5-210.8-409.7-445-409.7z" p-id="5765"></path></svg>
      <svg v-show="!edit.is3D" t="1635142140694" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5371" width="100%" height="100%"><path d="M342.7 536.6c-30.6 21.9-50.1 42.6-58.3 62.1-8.5 17.4-13 36.6-13.6 57.7h201v-50.8H343.7c3.6-6.1 8.1-11.4 13.5-16 5.3-4.6 15.2-12 29.7-22.3l23.1-16.4c19.5-13.8 33.5-26.2 42-37.4 13-16.9 19.5-36.2 19.5-57.9 0-28.3-9.2-51.1-27.6-68.3-18.4-17.2-43.1-25.8-74.2-25.8-39.3 0-66.7 14.6-82.1 43.9-8.1 15.4-12.6 35.6-13.6 60.5h56.1c0.7-16.5 2.8-28.5 6.5-36 6.3-13.1 18.3-19.6 35.8-19.6 12.8 0 22.7 4.1 29.6 12.3 6.9 8.2 10.3 18.6 10.3 31 0 15.2-6 29.3-18 42.1-7.8 8.2-25 21.8-51.6 40.9zM343.5 863.4c-121.6-57.7-208.9-176-222.1-316H65.5c19 229.4 210.8 409.6 445 409.6 8.4 0 16.4-0.7 24.6-1.3l-141.9-142-49.7 49.7zM695.4 399.8c-11.9-12.4-26.3-22.1-42.3-28.5-16.6-6.7-34.6-10.1-54.6-10.1h-88.1v297.9H596c20.7 0 39.3-3.4 56.2-10.1 16.9-6.7 31.3-16.2 43.2-28.5 11.9-12.3 21.2-27.2 27.6-44.5 6.5-17.3 9.7-36.9 9.7-58.5v-14.7c0-21.6-3.4-41-9.9-58.5-6.6-17.4-15.7-32.3-27.4-44.5z m-14.5 118h-0.2c0 15.5-1.7 29.6-5.4 41.9-3.5 12.5-8.8 22.9-15.8 31.5-7.1 8.6-15.8 15.1-26.4 19.7-10.6 4.5-22.9 6.9-37.1 6.9h-33.7V402.9h36.3c26.8 0 47.1 8.6 61.3 25.5 14 17.1 21 41.7 21 74.1v15.3zM510.5 63.3c-8.4 0-16.4 0.7-24.6 1.3l141.9 142.1 49.5-49.5C799.1 214.7 886.4 333 899.6 473h55.9c-19-229.5-210.8-409.7-445-409.7z" p-id="5372"></path></svg>
    </div>
    <div v-show="edit.is3D" @click="edit.isAll = !edit.isAll">
      <!-- 全部 单层 -->
      <svg v-show="edit.isAll" t="1635143998255" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="21667" width="100%" height="100%"><path d="M954.66666687 368l-426.66666656 170.66666625c-10.66666687 5.33333344-26.66666625 5.33333344-37.33333406 0L69.33333313 368C37.33333344 351.99999969 37.33333344 303.99999969 69.33333313 288.00000031l421.33333312-176.00000062c10.66666687-5.33333344 26.66666625-5.33333344 37.33333406 0l421.33333313 176.00000062c37.33333312 16.00000031 37.33333312 64.00000031 5.33333343 79.99999969zM938.66666656 730.66666625l-410.66666625 176.00000063s-10.66666687 5.33333344-16.00000031 5.33333343-16.00000031-5.33333344-16.00000031-5.33333343l-426.66666657-176.00000063c-16.00000031-5.33333344-26.66666625-21.33333375-26.66666624-42.66666656 0-26.66666625 21.33333375-48 48-48 5.33333344 0 16.00000031 5.33333344 15.99999937 5.33333344L512 816.00000031l405.33333375-170.66666719s10.66666687-5.33333344 15.99999937-5.33333343c26.66666625 0 48 21.33333375 48 48-5.33333344 21.33333375-16.00000031 31.99999969-42.66666656 42.66666656z" p-id="21668"></path><path d="M938.66666656 560l-410.66666625 175.99999969s-10.66666687 5.33333344-16.00000031 5.33333343-16.00000031-5.33333344-16.00000031-5.33333343l-426.66666657-175.99999969c-16.00000031-5.33333344-26.66666625-21.33333375-26.66666624-42.66666656 0-26.66666625 21.33333375-48 48-48 5.33333344 0 16.00000031 5.33333344 15.99999937 5.33333344L512 645.33333312l405.33333375-170.66666624s10.66666687-5.33333344 15.99999937-5.33333344c26.66666625 0 48 21.33333375 48 48-5.33333344 21.33333375-16.00000031 31.99999969-42.66666656 42.66666656z" p-id="21669"></path></svg>
      <svg v-show="!edit.isAll" t="1635142718292" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="21259" width="100%" height="100%"><path d="M1024 512c0-23.68-13.44-43.52-32.64-54.4l0.64-0.64-448-256-0.64 0.64C533.76 195.84 523.52 192 512 192s-21.76 3.84-31.36 9.6l-0.64-1.28-448 256 0.64 0.64C13.44 468.48 0 488.32 0 512s13.44 43.52 32.64 54.4l-0.64 0.64 448 256 0.64-0.64c9.6 5.76 19.84 9.6 31.36 9.6s21.76-3.84 31.36-9.6l0.64 0.64 448-256-0.64-0.64c19.2-10.88 32.64-30.72 32.64-54.4z" p-id="21260"></path></svg>
    </div>
    <div>
      <!-- 楼层按钮 -->
    </div>

    <div class="storey" v-show="!edit.is3D">
      <!-- 编辑地板 -->
      <svg @click="edit.isEditStorey = !edit.isEditStorey"  t="1635142718292" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="21259" width="100%" height="100%"><path d="M1024 512c0-23.68-13.44-43.52-32.64-54.4l0.64-0.64-448-256-0.64 0.64C533.76 195.84 523.52 192 512 192s-21.76 3.84-31.36 9.6l-0.64-1.28-448 256 0.64 0.64C13.44 468.48 0 488.32 0 512s13.44 43.52 32.64 54.4l-0.64 0.64 448 256 0.64-0.64c9.6 5.76 19.84 9.6 31.36 9.6s21.76-3.84 31.36-9.6l0.64 0.64 448-256-0.64-0.64c19.2-10.88 32.64-30.72 32.64-54.4z" p-id="21260"></path></svg>
      <ul v-show="edit.isEditStorey" class="storey-list">
        <li v-for="(s,i) in edit.storeys" :key="s.id"><div @click="editStorey(s,i)">{{s.name}}</div></li>
        <li @click="addStorey"><svg t="1666586819898" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2173" width="64" height="64"><path d="M940.809299 333.581448c-23.391756-57.684794-57.752332-109.431342-102.126982-153.805992-44.37465-44.37465-96.124268-78.736249-153.808038-102.128005C629.167536 55.056943 570.307987 43.603077 509.933945 43.603077c-60.375066 0-119.232568 11.453866-174.939311 34.044374-57.68377 23.391756-109.431342 57.753355-153.805992 102.128005-44.37465 44.37465-78.734202 96.122221-102.125959 153.805992C56.473199 389.288191 45.019333 448.145693 45.019333 508.519736c0 60.375066 11.453866 119.231545 34.044374 174.939311 23.391756 57.68377 57.751309 109.431342 102.125959 153.805992 44.37465 44.37465 96.122221 78.734202 153.805992 102.126982 55.706743 22.589484 114.565269 34.044374 174.939311 34.044374 60.374042 0 119.232568-11.453866 174.939311-34.044374 57.684794-23.391756 109.433388-57.752332 153.810085-102.126982 44.373627-44.373627 78.733179-96.122221 102.125959-153.805992 22.589484-55.706743 34.044374-114.564245 34.044374-174.939311C974.85265 448.145693 963.398784 389.288191 940.809299 333.581448zM905.988236 669.338445c-21.491477 52.999075-53.075823 100.559277-93.874017 141.357472-40.800241 40.799218-88.361467 72.383564-141.360542 93.875041-51.201126 20.761859-105.308441 31.289634-160.819732 31.289634-55.512315 0-109.61963-10.527774-160.818709-31.289634-52.999075-21.491477-100.558254-53.075823-141.357472-93.874017-40.799218-40.799218-72.382541-88.35942-93.875041-141.358495-20.762883-51.200102-31.289634-105.307418-31.289634-160.818709 0-55.511291 10.527774-109.618607 31.289634-160.818709 21.491477-52.999075 53.075823-100.558254 93.875041-141.357472 40.799218-40.800241 88.358397-72.384587 141.357472-93.877087 51.200102-20.762883 105.307418-31.290657 160.818709-31.290657 55.511291 0 109.618607 10.527774 160.819732 31.290657 52.999075 21.491477 100.5603 53.076846 141.359518 93.877087 40.799218 40.799218 72.383564 88.358397 93.875041 141.357472 20.761859 51.200102 31.289634 105.307418 31.289634 160.818709C937.278893 564.031027 926.750095 618.138342 905.988236 669.338445z" p-id="2174"></path><path d="M810.369481 489.052359c-0.014326 0-0.029676 0-0.042979 0l-281.56577 0.635473 0.590448-282.148032c0.021489-10.376325-8.372691-18.804275-18.747993-18.826787-0.014326 0-0.025583 0-0.039909 0-10.356882 0-18.764366 8.385994-18.785855 18.747993l-0.591471 282.311761-281.725406 0.636496c-10.376325 0.023536-18.767436 8.453533-18.744923 18.829857 0.023536 10.361999 8.429996 18.744923 18.785855 18.744923 0.014326 0 0.029676 0 0.042979 0l281.561677-0.635473-0.590448 282.152125c-0.021489 10.375302 8.372691 18.804275 18.747993 18.825764 0.014326 0 0.025583 0 0.039909 0 10.355859 0 18.764366-8.385994 18.785855-18.747993l0.590448-282.314831 281.728476-0.636496c10.376325-0.023536 18.768459-8.453533 18.744923-18.829857C829.131801 497.435283 820.726364 489.052359 810.369481 489.052359z" p-id="2175"></path></svg></li>
      </ul>
      <ul v-show="edit.isEditStorey" class="storey-edit">
        <li>层名：<input type="text" v-model="edit.storey.name"></li>
        <li>颜色：<input type="text" v-model="edit.storey.color"></li>
        <li>层高：<input type="number" v-model="edit.storey.storeyHeight"></li>
        <li>地板高：<input type="number" v-model="edit.storey.floorHeight"></li>
        <li>新建楼层是是否使用该地板：<input type="checkbox" v-model="edit.isCopyFloor"></li>
        <li>
          <button @click="editRoom">编辑房间</button>
          <button @click="edit.isEditRoom = true">保存</button>
        </li>
      </ul>
    </div>
    <div v-show="!edit.is3D" @click="edit.isDraw = !edit.isDraw">
      <!-- 描点 -->
      <svg v-show="edit.isDraw" t="1666510921561" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4939" width="64" height="64"><path d="M284.138785 892.100946h-100.79622a93.890879 93.890879 0 0 0-51.358074-51.242878V183.180331c23.826307-9.158057 42.13602-29.272502 51.358074-51.249278h654.330662c14.725848 34.782696 49.495744 58.615402 87.983901 58.615402 53.150007 0 95.292427-42.148819 95.292426-95.254028 0-53.169206-42.14242-95.254028-95.292426-95.254028-40.344087 0-75.177981 23.826307-87.983901 58.615401H183.342565A96.252391 96.252391 0 0 0 95.294667 0.102396C42.14466 0.102396 0.00224 42.251216 0.00224 95.356424c0 40.292889 23.826307 75.075585 58.6602 87.887904v657.549742A94.300464 94.300464 0 0 0 0.00224 928.745972C0.00224 981.915178 42.208657 1024 95.358664 1024c40.344087 0 75.113983-23.826307 87.983901-58.615402h100.79622a36.760221 36.760221 0 0 0 36.625826-36.638626 36.760221 36.760221 0 0 0-36.625826-36.638626z m97.148357 47.601415c-3.654263 12.81232 9.151657 25.618239 21.957576 22.034374l152.154295-42.14882-131.918253-131.899053-42.264016 152.013499h0.063998z m562.686099-606.249265c-16.460183-16.460183-43.99195-14.66185-62.308063 1.86233L817.501184 399.383423l128.327987 128.238391 64.163994-64.061598c18.316113-18.380111 18.316113-45.86068 1.791933-62.320862l-67.811857-67.773459z m-476.564529 408.432683l124.680125 131.963052 317.044111-309.588391-128.263991-128.25119-313.524242 305.882929h0.063997z" p-id="4940"></path></svg>
      <!-- 框选 -->
      <svg v-show="!edit.isDraw" t="1666510839387" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2555" width="48" height="48"><path d="M385.47911111 902.59911111h83.74044444v41.41511111h-83.74044444zM217.99822222 902.59911111h83.74044445v41.41511111h-83.74044445zM113.55022222 881.89155555h-41.41511111v62.12266667H134.25777778v-41.41511111h-20.70755556zM72.13511111 546.816h41.41511111v83.74044445h-41.41511111zM72.13511111 211.85422222h41.41511111v83.74044445h-41.41511111zM72.13511111 714.41066667h41.41511111v83.74044444h-41.41511111zM72.13511111 379.33511111h41.41511111V463.07555555h-41.41511111zM72.13511111 128.11377778h41.41511111v-20.70755556H134.25777778V65.99111111h-62.12266667zM553.07377778 65.99111111h83.74044444v41.41511111h-83.74044444zM720.55466667 65.99111111h83.74044444v41.41511111h-83.74044444zM385.47911111 65.99111111h83.74044444v41.41511111h-83.74044444zM217.99822222 65.99111111h83.74044445v41.41511111h-83.74044445zM888.03555555 65.99111111v41.41511111h20.70755556v20.70755556h41.41511111V65.99111111zM908.74311111 379.33511111h41.41511111V463.07555555h-41.41511111zM908.74311111 211.85422222h41.41511111v83.74044445h-41.41511111zM738.75911111 637.26933333l70.08711111-54.272c5.23377778-4.096 8.07822222-10.46755555 7.50933333-17.06666666-0.56888889-6.59911111-4.43733333-12.51555555-10.24-15.58755556L451.47022222 359.424c-6.82666667-3.64088889-15.13244445-2.95822222-21.27644444 1.70666667-6.144 4.77866667-8.87466667 12.62933333-7.05422223 20.13866666l95.91466667 391.168c1.59288889 6.48533333 6.25777778 11.60533333 12.51555556 13.76711112 6.25777778 2.16177778 13.19822222 1.024 18.432-2.95822223l70.08711111-54.272 151.552 195.69777778c3.86844445 5.00622222 9.67111111 7.62311111 15.47377778 7.62311111 4.20977778 0 8.41955555-1.36533333 11.94666666-4.096l87.60888889-67.81155556c4.096-3.18577778 6.82666667-7.85066667 7.39555556-12.97066666 0.68266667-5.12-0.79644445-10.35377778-3.98222223-14.44977778l-151.32444444-195.69777778z" p-id="2556"></path></svg>
    </div>
    <div class="btns" v-show="edit.isEditRoom">
      <button @click="addRoom">添加房间</button>
      <button>取消</button>
    </div>
  </div>

  <canvas v-show="!edit.is3D" id="myCanvas" @click="clickCanvas"></canvas>
  <div v-if="edit.is3D" id="container"></div>
</div>
</template>

<script setup>
import { nextTick, reactive, ref } from "vue";
import {init, animate} from "./util/modeling.js"
import {getCanvas,drawLine,clearCanvas,draw} from "./util/canvas.js"
const edit = reactive({
  is3D:false,
  isAll:false,
  isDraw:false,
  isEditStorey:false,
  isCopyFloor:false,
  isEditRoom:false,
  storeys:[],
  storey:{},
})
let inx = 0
let editPoints = []

nextTick(function () {
  getCanvas();
});
function clickCanvas(e) {
    let x = e.clientX // - (Cwidth / 2)
    let y = e.clientY // - (Cheight / 2)
    if (!edit.storeys[inx]) return alert('先添加楼层')
    // const points = edit.storeys[inx].points
    editPoints.push([x, y])
    drawLine(editPoints)
}
function transform3D(){
  edit.is3D = !edit.is3D
  saveData()
  nextTick(() => {
    if(edit.is3D){
      init(edit.storeys)
      animate()
    }
  })
}
function clickStorey(storey){
  clearCanvas()
  let {points,rooms} = storey
  editPoints = points
  draw(points)
  for(let r of rooms){
    draw(r.points)
  }
}
function saveData(){
  localStorage.setItem('data',JSON.stringify(edit.storeys))
}
function addStorey(){
  edit.storeys.push({
    id:new Date().getTime().toString(16),
    index:edit.storeys.length,
    name:edit.storeys.length,
    storeyHeight:100,
    floorHeight:10,
    color: "#049ef4",
    points:edit.isCopyFloor ? edit.storeys[edit.storeys.length - 1].points : [],
    rooms:[]
  })
}
function addRoom(){
  edit.storeys[inx].rooms.push({
    color: "#ffaa99",
    id:new Date().getTime().toString(16),
    logo:"",
    name:"",
    roomHeight:50,
    points: editPoints
  })
  edit.isEditRoom = false
}
function editRoom(){
  edit.isEditRoom = true
  editPoints = []
}
function editStorey(storey,i){
  // edit.storey = edit.storeys[inx]
  edit.storey = storey
  inx = i
  clickStorey(storey)
}
function delStorey(inx){
  edit.storeys.splice(inx,1)
}
</script>

<style scoped>
.layer{
  position: fixed;
  left: 10px;
  top: 10px;
}
.icon{
  fill: aqua;
  width: 40px;
  height: 40px;
}
ul{
  margin: 0px;
  padding: 0px;
  list-style: none;
}
.edit-storey{
  position: relative;
}
.storey-list{
  position: absolute;
  left: 90px;
  top: 10px;
}
.storey-edit{
  position: absolute;
  left: 160px;
  top: 10px;
  
}
input{
  text-align: center;
  width: 90px;
  padding: 2px 0px;
  background-color: #00ffff;
  border: none;
}
</style>